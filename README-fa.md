# جعبه‌ابزار بکاپ و مهاجرت وردپرس

این جعبه‌ابزار مجموعه‌ای از اسکریپت‌های بش (Bash) است که برای مدیریت ساده‌تر سایت‌های وردپرسی طراحی شده‌اند. این ابزارها شامل بکاپ‌گیری، همگام‌سازی بین محیط‌های استیجینگ و پروداکشن، انتقال فایل‌ها و زمان‌بندی وظایف هستند. این پروژه با تمرکز بر انعطاف‌پذیری و خودکارسازی ساخته شده و از عملیات محلی و ریموت پشتیبانی می‌کند.

## ویژگی‌ها

- **همگام‌سازی (`sync.sh`)**: همگام‌سازی فایل‌ها و/یا دیتابیس بین محیط پروداکشن و استیجینگ در هر دو جهت (`push` یا `pull`).
- **بکاپ فایل‌ها (`files.sh`)**: بکاپ‌گیری از فایل‌های وردپرس به صورت محلی یا روی سرور ریموت با پشتیبانی از بکاپ افزایشی و الگوهای مستثنی قابل تنظیم.
- **زمان‌بندی کرون (`cron-scheduler.sh`)**: زمان‌بندی خودکار بکاپ‌ها (کامل، دیتابیس یا فایل‌ها) با گزینه‌های فرکانس متنوع (روزانه، هفتگی و غیره).
- **نصب و راه‌اندازی (`setup.sh`)**: نصب پیش‌نیازها و ایجاد فایل‌های پیکربندی برای بکاپ و مهاجرت به صورت تعاملی.
- **مهاجرت (`migrate.sh`)**: انتقال سایت وردپرسی از یک سرور به سرور دیگر (محلی به ریموت یا ریموت به ریموت).
- **استیجینگ (`staging.sh`)**: ایجاد محیط استیجینگ از سایت پروداکشن وردپرس.
- **ابزارهای مشترک (`common.sh`)**: توابع مشترک برای لاگ‌گیری، به‌روزرسانی وضعیت، اعلان‌ها و بارگذاری پیکربندی.

### قابلیت‌های کلیدی
- پشتیبانی از عملیات محلی و ریموت از طریق SSH.
- بکاپ افزایشی برای استفاده بهینه از فضای ذخیره‌سازی.
- فرمت‌های فشرده‌سازی قابل تنظیم (`tar.gz`، `zip`، `tar`).
- محدودیت‌های اندازه فایل و الگوهای مستثنی قابل شخصی‌سازی.
- پشتیبانی از اعلان‌ها از طریق ایمیل، اسلک و تلگرام.
- حالت dry-run برای تست بدون اعمال تغییرات.
- لاگ‌گیری دقیق برای دیباگ.

## پیش‌نیازها

- **سیستم‌عامل**: لینوکس (تست‌شده با مدیر بسته‌های `apt` و `yum`).
- **ابزارهای مورد نیاز**:
  - `bash`، `rsync`، `curl`، `pigz`، `unzip`، `zip`، `mysql-client`، `mailutils`.
  - WP-CLI (`wp`) برای عملیات وردپرس.
- **اختیاری**: دسترسی SSH برای عملیات ریموت، Gravity Forms CLI برای بکاپ فرم‌ها.

## نصب

1. **دریافت پروژه** (در صورت استفاده از گیت):
   ```bash
   git clone <آدرس-مخزن>
   cd <پوشه-پروژه>
   ```

2. **اجرای اسکریپت راه‌اندازی**:
   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```
   - این اسکریپت پیش‌نیازها (مانند `rsync` و `wp-cli`) را نصب می‌کند و شما را برای ایجاد فایل‌های پیکربندی راهنمایی می‌کند.

3. **تنظیم مجوزها**:
   ```bash
   chmod +x *.sh
   ```

## پیکربندی

فایل‌های پیکربندی در پوشه `configs/` ذخیره می‌شوند و با `setup.sh` ایجاد می‌شوند. هر اسکریپت به یک فایل `.conf` نیاز دارد که تنظیماتی مثل مسیرها، اطلاعات SSH و روش‌های اعلان را مشخص کند.

### نمونه فایل پیکربندی (`configs/mywebsite.conf`)
```bash
# تنظیمات SSH (اختیاری برای عملیات ریموت)
destinationPort=22
destinationUser="user"
destinationIP="192.168.1.100"
destinationDbBackupPath="/backups/db"
destinationFilesBackupPath="/backups/files"
privateKeyPath="/root/.ssh/id_rsa"

# تنظیمات وردپرس
wpPath="/var/www/mywebsite"
stagingPath="/var/www/mywebsite-staging"
stagingUrl="http://staging.mywebsite.com"
maxSize="50m"

# تنظیمات بکاپ
fullPath="/var/www/backups"
BACKUP_RETAIN_DURATION=10
NICE_LEVEL=19
COMPRESSION_FORMAT="tar.gz"
LOG_LEVEL="normal"
BACKUP_LOCATION="both"

# تنظیمات اعلان
NOTIFY_METHOD="email,slack"
NOTIFY_EMAIL="admin@mywebsite.com"
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/xxx/yyy/zzz"
```

## استفاده

### 1. همگام‌سازی (`sync.sh`)
همگام‌سازی فایل‌ها و/یا دیتابیس بین پروداکشن و استیجینگ.

```bash
./sync.sh -c configs/mywebsite.conf -t <db|files|both> -d <push|pull> [-p] [-v]
```
- `-t`: نوع همگام‌سازی (`db` برای دیتابیس، `files` برای فایل‌ها، `both` برای هر دو).
- `-d`: جهت همگام‌سازی (`push` برای استیجینگ به پروداکشن، `pull` برای پروداکشن به استیجینگ).
- `-p`: اجرای خشک (پیش‌نمایش تغییرات).
- `-v`: لاگ دقیق.

**مثال**:
```bash
./sync.sh -c configs/mywebsite.conf -t both -d pull -v
```

### 2. بکاپ فایل‌ها (`files.sh`)
بکاپ‌گیری از فایل‌های وردپرس به صورت محلی یا روی سرور ریموت.

```bash
./files.sh -c configs/mywebsite.conf [-f <format>] [-d] [-i] [-v]
```
- `-f`: فرمت فشرده‌سازی (`tar.gz`، `zip`، `tar`).
- `-d`: اجرای خشک.
- `-i`: بکاپ افزایشی.
- `-v`: لاگ دقیق.

**مثال**:
```bash
./files.sh -c configs/mywebsite.conf -f zip -i
```

### 3. زمان‌بندی کرون (`cron-scheduler.sh`)
زمان‌بندی خودکار بکاپ‌ها.

```bash
./cron-scheduler.sh configs/mywebsite.conf [dry_run] [verbose] [compression] [location]
```
- آرگومان‌ها:
  - `dry_run`: `true` یا `false`.
  - `verbose`: `true` یا `false`.
  - `compression`: `tar.gz`، `zip` یا `tar`.
  - `location`: `l` (محلی)، `r` (ریموت)، `b` (هر دو).

**مثال**:
```bash
./cron-scheduler.sh configs/mywebsite.conf false true tar.gz b
```

### 4. راه‌اندازی (`setup.sh`)
نصب پیش‌نیازها و ایجاد فایل‌های پیکربندی.

```bash
./setup.sh
```
- به صورت تعاملی ابزارها را نصب و فایل‌های پیکربندی را ایجاد می‌کند.

### 5. مهاجرت (`migrate.sh`)
انتقال سایت وردپرسی بین سرورها.

```bash
./migrate.sh -c configs/migrate_site.conf [-d] [-v]
```
- `-d`: اجرای خشک.
- `-v`: لاگ دقیق.

**مثال**:
```bash
./migrate.sh -c configs/migrate_site.conf -v
```

### 6. استیجینگ (`staging.sh`)
ایجاد محیط استیجینگ از سایت پروداکشن.

```bash
./staging.sh -c configs/mywebsite.conf [-d] [-v]
```
- `-d`: اجرای خشک.
- `-v`: لاگ دقیق.

**مثال**:
```bash
./staging.sh -c configs/mywebsite.conf
```

## لاگ‌ها و اعلان‌ها

- **لاگ‌ها**: در فایل‌هایی مثل `sync.log` و `files.log` ذخیره می‌شوند.
- **وضعیت**: در فایل‌های `<script>_status.log` به‌روز می‌شود.
- **اعلان‌ها**: از طریق روش‌های تنظیم‌شده (ایمیل، اسلک، تلگرام) ارسال می‌شوند.

## شخصی‌سازی

- **الگوهای مستثنی**: متغیر `EXCLUDE_PATTERNS` را در `files.sh` یا فایل پیکربندی تغییر دهید (مثلاً `wp-staging,*.log,cache`).
- **مدت نگهداری**: `BACKUP_RETAIN_DURATION` را در فایل پیکربندی تنظیم کنید.
- **عملکرد**: `NICE_LEVEL` را برای اولویت فرآیند یا `maxSize` را برای محدودیت اندازه فایل تنظیم کنید.

## عیب‌یابی

- **مشکلات مجوز**: مطمئن شوید اسکریپت‌ها مجوز اجرا دارند (`chmod +x`) و کلیدهای SSH قابل خواندن هستند (`chmod 600`).
- **ابزارهای گم‌شده**: با `setup.sh` پیش‌نیازها را نصب کنید.
- **لاگ دقیق**: از `-v` برای جزییات بیشتر استفاده کنید.
- **اجرای خشک**: با `-d` یا `-p` تغییرات را پیش‌نمایش کنید.

## مشارکت

اگر پیشنهادی برای بهبود یا افزودن قابلیت دارید، لطفاً مشکلات را گزارش دهید یا درخواست الحاق کد ارسال کنید!

## مجوز

این پروژه تحت مجوز MIT منتشر شده است. برای اطلاعات بیشتر فایل `LICENSE` را ببینید.
